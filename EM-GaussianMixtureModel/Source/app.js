
// initializing data
let mIrisX = tf.tensor(iris).slice([0,1],[150,2])
mIrisX = normalizeData(mIrisX,unitVariance=1);
// one hot encoded
let mIrisY = Array(150).fill([1,0],0,50).fill([0,1],50);

let augIrisData = mIrisX.concat(tf.tensor(mIrisY),axis=1).arraySync();
tf.util.shuffle(augIrisData,axis=0);
augIrisData = tf.tensor( augIrisData );

let testX =   augIrisData.slice([0,0],[25,2]);
let testY =   augIrisData.slice([0,2],[25,-1]);

const mIrisXArray = mIrisX.arraySync();
tf.util.shuffle(mIrisXArray);
mIrisX = tf.tensor(mIrisXArray);

const k = 5;

const myMeans = [];
const myCovariance = [];
const myMixingCoeff = [];


let myModel = new GMM();
const { mean: mean, covariance: covariance, mixingCoeff: mixingCoeff} = myModel.train( mIrisX, k,0.0001,200);

// save the model for future use:

const modelParams = myModel.exportModelParams();

// write('Source/savedModel.txt', JSON.stringify(modelParams))

const gridRange0 = [-2, 2];
const gridRange1 = [-3, 3.5];
const psudoPtsGridRes = 100;

const psudoPts0 = tf.linspace( gridRange0[0],gridRange0[1],psudoPtsGridRes).expandDims(1);
const psudoPts1 = tf.linspace( gridRange1[0],gridRange1[1],psudoPtsGridRes).expandDims(1);
const psudoPts  = psudoPts0.concat(psudoPts1,axis=1);


let meshGridPsudoPts = tf.tensor(meshGrid(psudoPts1.flatten().arraySync(),psudoPts0.flatten().arraySync()))
meshGridPsudoPts = meshGridPsudoPts.reshape([meshGridPsudoPts.shape[0]*meshGridPsudoPts.shape[1], meshGridPsudoPts.shape[2]]);
let meshGridZ = myModel.test(meshGridPsudoPts)

const layoutSetting = {
    title: 'Gaussian Mixture Model',
    font : {
        size : 15,
        color: 'white',
        family : 'Helvetica'
    },
    paper_bgcolor : '#222633',
    width: 800,
    height: 800,

}


const clusterData = [

        // {
        //     x: mIrisX.slice([0,0],[-1,1]).flatten().arraySync(),
        //     y: mIrisX.slice([0,1],[-1,-1]).flatten().arraySync(),
        //     z: (new Array(mIrisX.shape[0])).fill(0),
        //     type: 'scatter',
        //     // type: 'scatter3d',

        //     mode: 'markers',
        //     name: ' data',
        //     opacity: .4,

        //     marker : {
        //         size: 20,
        //         color: 'orange'
        //     }
        // },

        {  
            x: meshGridPsudoPts.slice([0,0],[-1,1]).flatten().arraySync(),
            y: meshGridPsudoPts.slice([0,1],[-1,1]).flatten().arraySync(),
            z: meshGridZ.flatten().arraySync(),
            intensity: meshGridZ.flatten().arraySync(),
            type: "mesh3d",
            type: 'contour',
            // opacity : 0.7,
            // color: 'pink'

            colorscale: [
                [0, darkModeCols.blue()],
                [0.25, darkModeCols.purple()],
                [0.5, darkModeCols.magenta()],
                [0.75, darkModeCols.yellow()],
                [1, darkModeCols.red()]
            ],
        }



];



// for(let i=0; i<k; i++){

//     const currColor = 'rgb('+Math.random()*255+','+Math.random()*255+','+Math.random()*255+')';
//     // plotData.push(
//     //     {
//     //         x: clusterData[i].slice([0,0],[-1,1]).flatten().arraySync(),
//     //         y: clusterData[i].slice([0,1],[-1,-1]).flatten().arraySync(),

//     //         mode: 'markers',
//     //         type: 'scatter',
//     //         legendgroup: 'group'+i+'',
//     //         name: 'cluster'+i+' data',

//     //         marker : {
//     //             size: 10,
//     //             color: currColor,
//     //         }
//     //     }
//     // )

//     clusterData.push(
//         {

//             x: [mean[i].flatten().arraySync()[0]],
//             y: [mean[i].flatten().arraySync()[1]],


//             mode: 'markers',
//             type: 'scatter',
//             legendgroup: 'group'+i+'',
//             name: 'cluster'+i+' mean',

//             marker : {
//                 size: 50,
//                 color: currColor,
//                 opacity: .7,
//                 line: {
//                     color: 'rgb(231, 99, 250)',
//                     width: 6
//                   },
//             }
//         }
//     )
    
// }



Plotly.newPlot('GMMViz', clusterData, layoutSetting)



// const meanString = "[[[0.21994946897029877,-0.38176169991493225],[0.6810374855995178,-0.28683602809906006],[-0.5128003358840942,0.5711686611175537],[-0.22508786618709564,0.42332127690315247],[0.18648764491081238,0.41771069169044495],[-0.6545068025588989,-0.14401096105575562],[-1.0942589044570923,0.3880433440208435],[0.3499521315097809,-0.6042547821998596],[-0.40767911076545715,-0.10365752130746841],[-0.3722562789916992,0.5221419334411621]],[[0.28837016224861145,-0.4757499098777771],[0.7241965532302856,-0.47359225153923035],[-0.4755156934261322,0.6076632738113403],[-0.2128976285457611,0.4722180664539337],[0.27724170684814453,0.4370120167732239],[-0.7894233465194702,-0.0016158877406269312],[-1.1383702754974365,0.4205700159072876],[0.5240680575370789,-0.4101314842700958],[-0.35748112201690674,-0.18785564601421356],[-0.34579578042030334,0.7271310687065125]],[[0.3314446806907654,-0.5782814025878906],[0.7735610604286194,-0.7112838625907898],[-0.4381265938282013,0.6316955089569092],[-0.22486627101898193,0.5459687113761902],[0.38429179787635803,0.523292601108551],[-0.9042422771453857,0.1417350023984909],[-1.2168322801589966,0.43560168147087097],[0.8849661350250244,0.17029358446598053],[-0.3020673394203186,-0.25895318388938904],[-0.3439430892467499,0.878275454044342]],[[0.36356988549232483,-0.6982882022857666],[0.8211665153503418,-0.9555319547653198],[-0.4093080461025238,0.6484391093254089],[-0.31223568320274353,0.6409732699394226],[0.354369193315506,0.5794284343719482],[-0.9909897446632385,0.2859014868736267],[-1.2918040752410889,0.45254838466644287],[1.1925288438796997,0.700908362865448],[-0.2517383098602295,-0.2949393689632416],[-0.3664712905883789,1.0482819080352783]],[[0.41021066904067993,-0.8158579468727112],[0.8625807166099548,-1.1719900369644165],[-0.396599680185318,0.6566795706748962],[-0.4649873375892639,0.801704466342926],[0.04674609750509262,0.5511056184768677],[-1.0404855012893677,0.42711642384529114],[-1.3310590982437134,0.4911799132823944],[1.2659912109375,0.8328837752342224],[-0.24343810975551605,-0.2325899600982666],[-0.41329002380371094,1.237574577331543]],[[0.46557337045669556,-0.9390392899513245],[0.8837541937828064,-1.279036283493042],[-0.390907347202301,0.6574715375900269],[-0.5722799301147461,1.0117614269256592],[-0.2428845912218094,0.6019390225410461],[-1.078141689300537,0.5303706526756287],[-1.3609470129013062,0.537031352519989],[1.2511380910873413,0.801095187664032],[-0.29158279299736023,-0.0626019835472107],[-0.4688340127468109,1.4002736806869507]],[[0.5223660469055176,-1.0624065399169922],[0.8866764903068542,-1.2855864763259888],[-0.39154040813446045,0.6487754583358765],[-0.6027651429176331,1.1296027898788452],[-0.3959687054157257,0.6771390438079834],[-1.1307791471481323,0.5201979279518127],[-1.4099315404891968,0.5607414841651917],[1.2139369249343872,0.7290637493133545],[-0.3339327871799469,0.053709227591753006],[-0.5056615471839905,1.5026311874389648]],[[0.6348878145217896,-1.1891615390777588],[0.8880868554115295,-1.2900527715682983],[-0.4031289517879486,0.6297433376312256],[-0.5872676968574524,1.1765997409820557],[-0.46722927689552307,0.7404749989509583],[-1.1950112581253052,0.4406852722167969],[-1.4951924085617065,0.5461076498031616],[1.194122314453125,0.6902574300765991],[-0.3286536633968353,0.03520968183875084],[-0.5256942510604858,1.5679943561553955]],[[0.780830442905426,-1.281761884689331],[0.8891194462776184,-1.2929234504699707],[-0.427001416683197,0.6043797731399536],[-0.5590648055076599,1.1971997022628784],[-0.5074380040168762,0.8004013299942017],[-1.2629894018173218,0.3362841010093689],[-1.6203892230987549,0.4844658672809601],[1.2635951042175293,0.8033285737037659],[-0.3348206877708435,0.04257151111960411],[-0.5380021929740906,1.6164820194244385]],[[0.8354861736297607,-1.3075538873672485],[0.8883079290390015,-1.294629454612732],[-0.43515267968177795,0.5894551873207092],[-0.5294297933578491,1.1871085166931152],[-0.5148454904556274,0.8242921233177185],[-1.2941213846206665,0.3121051788330078],[-1.7105703353881836,0.4541967511177063],[1.4673142433166504,1.1467450857162476],[-0.39235547184944153,0.20907066762447357],[-0.5306889414787292,1.6165049076080322]]]";
// const covarianceString ="[[[[1.4144420623779297,-0.5065394043922424],[-0.5065394043922424,1.1610019207000732]],[[0.055302541702985764,-0.17870256304740906],[-0.17870256304740906,1.2738838195800781]],[[0.329336941242218,0.054989758878946304],[0.054989758878946304,0.11696021258831024]],[[0.684210479259491,-0.16148418188095093],[-0.16148418188095093,1.0329501628875732]],[[1.0296434164047241,-0.44280627369880676],[-0.44280627369880676,1.227478265762329]],[[0.4938872158527374,0.09569258987903595],[0.09569258987903595,0.5132280588150024]],[[0.5376562476158142,0.3044792711734772],[0.3044792711734772,0.4610288739204407]],[[0.385891854763031,0.4483657777309418],[0.4483657777309418,1.2900021076202393]],[[0.6387875080108643,-0.34426674246788025],[-0.34426674246788025,1.0042743682861328]],[[0.04426654055714607,-0.036466240882873535],[-0.036466240882873535,0.74813312292099]]],[[[1.403171181678772,-0.49322760105133057],[-0.49322760105133057,1.1149693727493286]],[[0.057508163154125214,-0.1878175139427185],[-0.1878175139427185,1.1652202606201172]],[[0.3524496853351593,0.09808488190174103],[0.09808488190174103,0.13337071239948273]],[[0.6675237417221069,-0.07504032552242279],[-0.07504032552242279,1.026010513305664]],[[1.0174527168273926,-0.25929421186447144],[-0.25929421186447144,1.2777976989746094]],[[0.5819228291511536,0.12028685957193375],[0.12028685957193375,0.657593309879303]],[[0.5595210790634155,0.30599266290664673],[0.30599266290664673,0.3809603452682495]],[[0.4702647030353546,0.7099056839942932],[0.7099056839942932,1.6059670448303223]],[[0.623173177242279,-0.37661316990852356],[-0.37661316990852356,1.0920335054397583]],[[0.04642103612422943,-0.05821310356259346],[-0.05821310356259346,0.6992747187614441]]],[[[1.3804320096969604,-0.5119327306747437],[-0.5119327306747437,1.028354287147522]],[[0.0508786141872406,-0.16096583008766174],[-0.16096583008766174,0.9261512160301208]],[[0.40833693742752075,0.13404560089111328],[0.13404560089111328,0.1524726152420044]],[[0.7000823020935059,-0.019073043018579483],[-0.019073043018579483,0.9864414930343628]],[[1.092381238937378,-0.027042046189308167],[-0.027042046189308167,1.294873595237732]],[[0.6356602907180786,0.17147833108901978],[0.17147833108901978,0.7200032472610474]],[[0.5770219564437866,0.29224371910095215],[0.29224371910095215,0.32541003823280334]],[[0.6085929274559021,1.0318713188171387],[1.0318713188171387,1.9863815307617188]],[[0.5929147601127625,-0.42334848642349243],[-0.42334848642349243,1.1455901861190796]],[[0.04722341522574425,-0.06581111997365952],[-0.06581111997365952,0.5802152156829834]]],[[[1.3481624126434326,-0.5468974709510803],[-0.5468974709510803,0.8856369853019714]],[[0.03875086084008217,-0.10720610618591309],[-0.10720610618591309,0.5797381401062012]],[[0.46429115533828735,0.1604107916355133],[0.1604107916355133,0.16676296293735504]],[[0.6579389572143555,-0.017735281959176064],[-0.017735281959176064,0.899037778377533]],[[1.1186708211898804,0.07956250011920929],[0.07956250011920929,1.2432143688201904]],[[0.6025185585021973,0.2381909042596817],[0.2381909042596817,0.7516753077507019]],[[0.5690534114837646,0.27919164299964905],[0.27919164299964905,0.296163946390152]],[[0.5523744225502014,0.9519374966621399],[0.9519374966621399,1.719184160232544]],[[0.5267833471298218,-0.45802074670791626],[-0.45802074670791626,1.2082258462905884]],[[0.04716198891401291,-0.06168969348073006],[-0.06168969348073006,0.40121668577194214]]],[[[1.3404043912887573,-0.5234637260437012],[-0.5234637260437012,0.7212603688240051]],[[0.024210859090089798,-0.04152226448059082],[-0.04152226448059082,0.20352917909622192]],[[0.4820528030395508,0.1641809344291687],[0.1641809344291687,0.17170283198356628]],[[0.4874158203601837,-0.05235480144619942],[-0.05235480144619942,0.7592617869377136]],[[0.962631106376648,-0.04786498472094536],[-0.04786498472094536,1.1591702699661255]],[[0.5036904811859131,0.30529695749282837],[0.30529695749282837,0.8424553871154785]],[[0.5393471121788025,0.27420470118522644],[0.27420470118522644,0.293780654668808]],[[0.5267553329467773,0.8936299085617065],[0.8936299085617065,1.5501749515533447]],[[0.4319545328617096,-0.48294445872306824],[-0.48294445872306824,1.341865062713623]],[[0.04560536891222,-0.05631960555911064],[-0.05631960555911064,0.2519923150539398]]],[[[1.376969814300537,-0.44539424777030945],[-0.44539424777030945,0.5248609185218811]],[[0.01623685099184513,-0.006305892486125231],[-0.006305892486125231,0.00992772076278925]],[[0.4822898209095001,0.1563757210969925],[0.1563757210969925,0.1708301305770874]],[[0.33578044176101685,-0.0634479969739914],[-0.0634479969739914,0.535054087638855]],[[0.7298604249954224,-0.14927364885807037],[-0.14927364885807037,1.0456598997116089]],[[0.4034341275691986,0.34184688329696655],[0.34184688329696655,0.9569312930107117]],[[0.5048240423202515,0.27581527829170227],[0.27581527829170227,0.30412065982818604]],[[0.5717349052429199,0.9595819115638733],[0.9595819115638733,1.6280401945114136]],[[0.3329927921295166,-0.49331986904144287],[-0.49331986904144287,1.4873744249343872]],[[0.039698343724012375,-0.04679061844944954],[-0.04679061844944954,0.14903120696544647]]],[[[1.4659624099731445,-0.35257142782211304],[-0.35257142782211304,0.3303819000720978]],[[0.017564961686730385,-0.005730596370995045],[-0.005730596370995045,0.006660987623035908]],[[0.48317527770996094,0.1487410068511963],[0.1487410068511963,0.16681133210659027]],[[0.2458650767803192,-0.0543929748237133],[-0.0543929748237133,0.338037371635437]],[[0.5343548655509949,-0.12411252409219742],[-0.12411252409219742,0.8321017622947693]],[[0.3358478248119354,0.3411117494106293],[0.3411117494106293,0.9703356027603149]],[[0.46450525522232056,0.26659128069877625],[0.26659128069877625,0.2968631088733673]],[[0.6276254057884216,1.05288565158844],[1.05288565158844,1.7780027389526367]],[[0.24474704265594482,-0.44713282585144043],[-0.44713282585144043,1.4712690114974976]],[[0.02774696610867977,-0.02828495390713215],[-0.02828495390713215,0.06785435974597931]]],[[[1.3994758129119873,-0.20990078151226044],[-0.20990078151226044,0.15194286406040192]],[[0.019418179988861084,-0.005625118035823107],[-0.005625118035823107,0.005507480353116989]],[[0.4932131767272949,0.14849288761615753],[0.14849288761615753,0.16460996866226196]],[[0.2004258781671524,-0.05293663218617439],[-0.05293663218617439,0.2575189471244812]],[[0.41767019033432007,-0.06489190459251404],[-0.06489190459251404,0.6000210046768188]],[[0.2907939553260803,0.30977317690849304],[0.30977317690849304,0.8957193493843079]],[[0.41723504662513733,0.2431613653898239],[0.2431613653898239,0.2690350413322449]],[[0.6467141509056091,1.0891363620758057],[1.0891363620758057,1.8443843126296997]],[[0.19434870779514313,-0.40121784806251526],[-0.40121784806251526,1.3795545101165771]],[[0.015465005300939083,-0.014185137115418911],[-0.014185137115418911,0.027594156563282013]]],[[[1.149518370628357,-0.039078060537576675],[-0.039078060537576675,0.03759410232305527]],[[0.019811145961284637,-0.005395384039729834],[-0.005395384039729834,0.004810449201613665]],[[0.514334499835968,0.1615772694349289],[0.1615772694349289,0.17040576040744781]],[[0.18293826282024384,-0.054170336574316025],[-0.054170336574316025,0.21713876724243164]],[[0.3536912798881531,-0.0027462036814540625],[-0.0027462036814540625,0.3956499397754669]],[[0.24825042486190796,0.25890156626701355],[0.25890156626701355,0.7814061045646667]],[[0.37220486998558044,0.22543871402740479],[0.22543871402740479,0.24510732293128967]],[[0.5919411778450012,1.002671480178833],[1.002671480178833,1.7075051069259644]],[[0.16160394251346588,-0.35281985998153687],[-0.35281985998153687,1.2348607778549194]],[[0.009485054761171341,-0.009022875688970089],[-0.009022875688970089,0.011018067598342896]]],[[[0.9924497604370117,0.020762935280799866],[0.020762935280799866,0.011030305176973343]],[[0.018258925527334213,-0.00515406671911478],[-0.00515406671911478,0.004472946282476187]],[[0.521543562412262,0.1700480431318283],[0.1700480431318283,0.17464695870876312]],[[0.18941333889961243,-0.057650789618492126],[-0.057650789618492126,0.18847116827964783]],[[0.3298451602458954,0.022742170840501785],[0.022742170840501785,0.279996782541275]],[[0.1966131031513214,0.17836099863052368],[0.17836099863052368,0.6125869154930115]],[[0.3056674003601074,0.19075998663902283],[0.19075998663902283,0.21035662293434143]],[[0.38204899430274963,0.6518257260322571],[0.6518257260322571,1.1198937892913818]],[[0.13786335289478302,-0.29290542006492615],[-0.29290542006492615,0.9975911974906921]],[[0.009966503828763962,-0.009797611273825169],[-0.009797611273825169,0.009631938301026821]]]]"; 
// const mixingCoeffString = "[[0.47141996026039124,0.12994466722011566,0.35873427987098694,0.03243514522910118,0.0008554320083931088,0.00037328340113162994,0.0015706885606050491,0.0036680104676634073,0.0009639644995331764,0.00003450087388046086],[0.4549797773361206,0.09709411859512329,0.40905362367630005,0.030721334740519524,0.0008138985722325742,0.00031202792888507247,0.001979994587600231,0.004097424913197756,0.0009080796153284609,0.000039614649722352624],[0.4298250079154968,0.07817576080560684,0.4530898928642273,0.028584333136677742,0.0007839971221983433,0.0002830379526130855,0.0024544745683670044,0.005897186696529388,0.0008579990826547146,0.00004828113742405549],[0.40088799595832825,0.06697182357311249,0.4906061589717865,0.026336191222071648,0.0006909345975145698,0.00027104109176434577,0.002967763226479292,0.010377743281424046,0.0008247936493717134,0.0000655300245853141],[0.37289538979530334,0.06149357184767723,0.5203618407249451,0.026066433638334274,0.0005371450097300112,0.0002878967206925154,0.0034873734693974257,0.013940760865807533,0.0008177303825505078,0.00011177190026501194],[0.33665135502815247,0.0679912120103836,0.544523298740387,0.02946436032652855,0.0004523441893979907,0.00033851468469947577,0.004091501235961914,0.015419752337038517,0.0008368058479391038,0.00023089261958375573],[0.2873435318470001,0.09008661657571793,0.565205991268158,0.034140001982450485,0.00038762204349040985,0.00038172706263139844,0.004815694876015186,0.016314232721924782,0.0008366627153009176,0.00048779824282974005],[0.26099589467048645,0.09221309423446655,0.583175539970398,0.03833440691232681,0.0003331200568936765,0.0003995881706941873,0.0057725259102880955,0.016853557899594307,0.0008165499311871827,0.0011057202937081456],[0.24652332067489624,0.08870887011289597,0.5964993238449097,0.0407659076154232,0.00029396169702522457,0.00041373129351995885,0.0072067598812282085,0.016026053577661514,0.0007224316941574216,0.0028396439738571644],[0.2525022625923157,0.07862867414951324,0.5977063775062561,0.04069766029715538,0.00027145512285642326,0.0004012565186712891,0.008604331873357296,0.01370352040976286,0.0005316822789609432,0.0069527099840343]]"; 



